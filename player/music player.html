<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>music player 代码整洁版</title>
	<script src="jquery/jquery.js"></script>
	<!-- <link rel="stylesheet" href="css/drag-button.css"> -->
	<link rel="stylesheet" href="css/reset.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>
	<div class="music-player-wrap" style="width:282px">
		<audio id="music-player" src="music/画情-姚贝娜.mp3" ></audio>
		<div class="music-volume clearfix">
			<div class="volume-0 left icon"></div>
			<div class="volume-drag left"></div>
			<div class="volume-1 left icon"></div>
		</div>
		<div class="song-logo-wrapper">
				<div class="song-logo icon"></div>
		</div>
		<div class="music-name">画情-姚贝娜</div>
		<div class="drag-bar-wrapper">
		<div class="drag-bar"></div>
		<div class="time-wrap clearfix">
			<div class="time-played left">00:00</div>
			<div class="time-info right">05:26</div>
		</div>
		</div>
		<div class="music-buttons">
			<div class="play-buttons clearfix">
				<a class="pre-song left icon">上一首</a>
				<div id="play-button" class="icon left">
					<a class="icon">play</a>
				</div>
				<a class="next-song left icon">下一首</a>
			</div>
		</div>
		<div class="music-buttons-footer clearfix">
			<a class="icon" id="song-list"></a>
			<a class="change-theme icon"></a>
				<div class="theme-box">
			<h1 class="clearfix">
				<p>主题颜色设置</p>
				<a href="javascript:;">x</a>
			</h1>
			<div class="theme-content">
				<ul class="clearfix">
					<li class="theme-item"></li>
					<li class="theme-item"></li>
					<li class="theme-item"></li>
					<li class="theme-item"></li>
				</ul>
			</div>
		</div>
		</div>
	</div>	
	<div id="modal-box"></div>

	<script>

			var bodySelect_g = function (t_or_f){

			if(t_or_f === true){

				$('body').css({

					'-moz-user-select': 'text',
					'-webkit-user-select': 'text',
					'-ms-user-select': 'text'

				});

			}
			if(t_or_f === false){

				$('body').css({

					'-moz-user-select': 'none',
					'-webkit-user-select': 'none',
					'-ms-user-selecct': 'none'

				});
			}
		}
	$(function(){			// for change theme box

		var $theme_head = $('.theme-box').click(function(event) {
			
			 event.stopPropagation();
			 
		}).find('h1')

			$theme_head.on('mouseenter', function () {

				$(this).css('cursor', 'move');

		}).on('mousedown', function (e) {

			var $that = $(this);

			bodySelect_g(false);

			var offset_left = e.pageX - parseInt($that.parent('.theme-box').css('left'));
			var offset_top =  e.pageY - parseInt($that.parent('.theme-box').css('top')); 

			$(window).on('mousemove', function (e) {


				// console.log($that.parent('.theme-box').css('left'))

				var offset_left_reset = e.pageX - offset_left ;

				var offset_top_rest = e.pageY - offset_top;

				console.log($that.parent('.theme-box').position().left)
				
				$that.parent('.theme-box').css({

					top: offset_top_rest + 'px',
					left: offset_left_reset + 'px' 
				});		

			}).on('mouseup', function () {
				
				$(this).off('mousemove');
				
				bodySelect_g(true);

			});
			
		});

		var player_theme = ['#304949','#C55F4C','#83BD38','#369EAC'];

		var $theme_item = $('.theme-box .theme-content').find('li');

		$theme_item.each(function(index, el) {

			$(this).css('background-color', player_theme[index])
					.click(function(event) {
						
						$('.music-player-wrap').css('background-color', player_theme[index]);
					});
		});

		$theme_head.find('a').click(function() {
				
				$theme_head.parent().fadeOut('600');

				$('#modal-box').fadeOut('300');

		});

	})


	$(function  () {
		
		var  createDragbar = function  ($dom , fun_for_mousemove, fun_for_mouseup , opts) {

			//fun_for_mouseup : function: while mouseup after dragging the drag-button
			
			opts = $.extend(
				{
					width: '285px',
					bar_height: '6px',
					margin: '6px 0',
					left_bg: '#74818b',
					button_bg: '#5a656e',
					right_bg: '#c7c7c7',
					dir: 'x'
				}
				, opts);

			opts.buttoon_size = parseInt(opts.bar_height) + 2 * parseInt(opts.margin) +'px';

			var $html = $('<div><p></p><a></a><p></p></div>');

			var e_mousemove_active = false;		//judge for mouseup

			if(opts.dir !== 'x' && opts.dir !== 'X'){

				 	$html.first().css({

						'-webkit-transform': 'rotate(90deg)',
						'-moz-transform': 'rotate(90deg)',
						'-ms-transform': 'rotate(90deg)'
				 	});
			}

			$html.addClass('clearfix').css({

					'position': 'relative',
					'display': 'inline-block'
				})

			.children('a').css({

				width: opts.buttoon_size,
				height: opts.buttoon_size,
				display: 'inline-block',
				position: 'absolute',
				top:0,
				left:0,
				'border-radius': '100%',
				'background-color': opts.button_bg

			}).on('mousedown', function (e) {

				var left_offset;

				var $that = $(this);

				e_mousemove_active = true;

				if(opts.dir != 'x' && (opts.dir != 'X')){

				 	left_offset =  -e.pageY + parseInt($(this).css('left'));
				 }

				else{

					left_offset = e.pageX - parseInt($(this).css('left'));
				}

				$(window).on('mousemove.drag_moving', function (e) {
					
					var left_reset;

					if(opts.dir != 'x' && (opts.dir != 'X')){

					 	left_reset = e.pageY + left_offset;
					 }

					else{

						left_reset = e.pageX - left_offset;
					}

						if(left_reset < 0){

							left_reset = 0;
						}

						var max_left = parseInt(opts.width)-parseInt(opts.buttoon_size);

						if(left_reset > max_left ){

							left_reset  = max_left;
						}
				
							bodySelect_g(false);

						$that.css({

							left: left_reset+'px',
						});

						$that.prev().width(left_reset);

						$that.next().width(parseInt(opts.width)-left_reset);

						fun_for_mousemove();

				}).on('mouseup', function () {

						if(!e_mousemove_active){

							return ;
						}

						$(this).off('.drag_moving');

						fun_for_mouseup();

						bodySelect_g(true);

						e_mousemove_active = false;

				});
				
			}).siblings('p').css({

				float: 'left',
				height: opts.bar_height

			});

			$html.children('p').css('margin', opts.margin)

			//		can add other ClassName using for more stylesheet

				.first().css({

						'background-color': opts.left_bg,
						'border-radius': '55px 0 0 55px'
					})

				.siblings('p').css({

					'background-color': opts.right_bg,
					'width': opts.width,
					'border-radius': '0 55px 55px 0'

				});

			$dom.append($html);

		}

		var url_ = 'music/';

		var music_list = [url_+'画情-姚贝娜.mp3',url_+'存在-汪峰.mp3',url_+'我是真的爱上你-王杰.mp3',url_+'味道-侯磊.mp3',url_+'一千年以后-林俊杰.mp3'];

		var music_index = 0;

		var __music_unit;	//__music_unit : every __music_unit seconds,drag button moving right 1px

		var music_len ;

		var time_, time_uadate_auto, music_wait;		//use for settimeinterval

		var $music_name = $('.music-name');

		var $time_info = $('.time-info'); 

		var $time_played = $('.time-played');

		var isplaying = false;

		var $drag_bar = $('.drag-bar');

		var player = $('#music-player')[0];				//audio tag


		var moveVolumebutton = function (){

			var $volume_drag = $('.volume-drag').children('div').children('a');
					
			player.volume = parseInt($volume_drag.css('left'))/
							($volume_drag.next().width()+$volume_drag.prev().width()-$volume_drag.width())
				}

			createDragbar($('.volume-drag'),
						moveVolumebutton,
						function(){},
						{width:'221px',
						left_bg: '#4FC797',
						button_bg: '#ffffff',
						right_bg: '#495C5C'}
						);

		var upDragbutton = function (){

					player.currentTime =  parseInt($drag_button.css('left')) * 
										__music_unit/1000;

					playInit();

					_time_update(player.currentTime);
		}
		var moveDragbutton = function  () {
					
					if(time_){

						clearTimeout(time_);
					}
		}

		createDragbar($drag_bar,moveDragbutton,upDragbutton,{
			width:'221px',
			left_bg: '#62c6c7',
			button_bg: '#ffffff',
			right_bg: '#172525'});

		var $drag_button = $drag_bar.children().children('a');

		var $drag_button_left = $drag_button.prev();

		var $drag_button_right = $drag_button.next();

		var drag_len = $drag_button_right.outerWidth()+
			$drag_button_left.outerWidth() - $drag_button.outerWidth();

		var switchMusic = function  (music_index,music_name) {

				$music_name.text(music_name);

				player.src=music_list[music_index];
			
				_time_update(0);

				dragInit($drag_button);	
				
				isplaying = true;		

				// $('#play-button').text('pause');

				if(time_){

					clearTimeout(time_);
				}

				if(music_wait){

					clearTimeout(music_wait);
				}
			 	
			 	music_wait = setTimeout(function  () {
				
				playInit();

				player.play();

			},100)

		}

		var _time_update = function  (time) {
			
			var mins = Math.floor(time / 60); 

			var secs = Math.floor(time - mins * 60) ; 

			var time_played = '0'+ mins +':' + (secs >= 10 ? secs :( '0'+ secs));

			$time_played.text(time_played);
		}

		var dragInit = function  ($dom) {
			
			$dom.css('left', '0');

			var width = $dom.next().outerWidth()+
			$dom.prev().outerWidth();

			$dom.prev().outerWidth('0');

			$dom.next().outerWidth(width);
		}

		var dragMoving = function  (__music_unit) {

			if( parseFloat($drag_button.css('left')) >= drag_len){	//music is over?

				isplaying = false;

				// $('#play-button').text('play');
				$('#play-button').children().css({
				
					'backgroundPositionX':'-131px',
					'left':'45%'

				});

				clearTimeout(time_);

				clearTimeout(time_uadate_auto);

				dragInit($drag_button);

				player.currentTime = 0;

				player.pause();

				_time_update(0);

				return; 				
			} 

			$drag_button_left.outerWidth('+=1');
			
			$drag_button_right.outerWidth('-=1');
			
			$drag_button.css('left',  '+=1px' );
			
		}

		function playInit () {

			if(time_uadate_auto){

				clearTimeout(time_uadate_auto);
			}

			time_uadate_auto = setInterval(function  () {

			_time_update(player.currentTime);

			},1000)

			music_len = player.duration;			//music time length

			var mins = Math.floor(music_len / 60); 

			var secs = Math.floor(music_len - mins * 60) ; 

			var time_data = '0'+ mins +':' + (secs >= 10 ? secs :( '0'+ secs));

			$time_info.text(time_data);

			 __music_unit = music_len / drag_len * 1000 ;

			 if(time_){					//time_ : the timer for every __music_unit seconds update once

			 	clearTimeout(time_);
			 }

			time_ = setInterval(function(){

				dragMoving(__music_unit);

			},__music_unit)

		}

		$('.music-player-wrap .change-theme').click(function() {
					
				$('.theme-box').css({
					'top': '-125px',
					'left': '248px'
				}).fadeIn('600');

				$('#modal-box').fadeIn('300');
		});

		$('#play-button').mousedown(function(event) {
			
			$(this).css('box-shadow','0 0 5px pink')

		}).mouseup(function(event) {

			$(this).css('box-shadow', 'none');

		}).click(function() {

			if(!isplaying){

				player.play();
				
				$(this).children().css({
				
					'backgroundPositionX':'-170px',
					'left':'40%'

				});

				
				playInit();

				isplaying = !isplaying;
			}

			else{

				player.pause();

				$(this).children().css({
				
					'backgroundPositionX':'-131px',
					'left':'45%'

				});

				isplaying = !isplaying;				
				
				clearTimeout(time_);
			}

		});

		var reg_music = /[^a-zA-Z0-9\/\:\.]+/;

		var music_name ='';

		var $song_list_ul = $('<ul></ul>').addClass('song-list-ul');

		var $song_list_li = $('<li></li>')

		$song_list_li.clone().text('所有歌曲').addClass('song-list-head').appendTo($song_list_ul).on('mousedown', function (e) {

			var $that = $(this);

			bodySelect_g(false);

			var offset_left = e.pageX - parseInt($that.parent().css('left'));

			var offset_top =  e.pageY - parseInt($that.parent().css('top')); 

			$(window).on('mousemove', function (e) {

				console.log($that.parent('.theme-box').css('left'))

				var offset_left_reset = e.pageX - offset_left ;

				var offset_top_rest = e.pageY - offset_top;

				 // console.log($that.parent().position().left)
				
				$that.parent().css({

					top: offset_top_rest + 'px',
					left: offset_left_reset + 'px' 
				});		

			}).on('mouseup', function () {
				
				$(this).off('mousemove');
				
				bodySelect_g(true);

			});
			
		});

			$.each(music_list, function(i, val) {

			$song_list_li.clone().text(music_list[i].

				match(reg_music)).on('dblclick', function () {

			$(this).addClass('playing_song').siblings().removeClass('playing_song');

			switchMusic( i , $(this).text() );

			$('#play-button').children().css({
				
				'backgroundPositionX':'-170px',
				'left':'40%'

			});
			
		}).hover(function() {
					
					$(this).addClass('song-list-items');

				}, function() {
					
					$(this).removeClass('song-list-items');

				}).appendTo($song_list_ul);

		});

		$song_list_ul.find('li:eq(1)').addClass('playing_song');

		$song_list_ul.appendTo('.music-buttons-footer');

		$('#song-list').click(function(event) {

			$song_list_ul.css({
				'top': '-198px',
				'left': '-213px'
			});
			
			$song_list_ul.show('500');

			$('#modal-box').fadeIn('300');
		});
		$('#modal-box').click(function(event) {

			$('.song-list-ul').fadeOut('500');

			$('.theme-box').fadeOut('500');

			$(this).fadeOut('300');
		});

		$('.pre-song').mousedown(function(event) {
			
			$(this).css('box-shadow','0 0 5px pink')

		}).mouseup(function(event) {

			$(this).css('box-shadow', 'none');
			
			setTimeout(function  () {
				
			bodySelect_g(true)
				
			},3000)

		}).click(function() {

			bodySelect_g(false);
			
			music_index = (music_index === 0) ? music_list.length-1 : music_index-1;  

			$('.song-list-ul').find('li:eq('+(music_index+1)+')').trigger('dblclick');
				
		});

		$('.next-song').mousedown(function(event) {
			
			$(this).css('box-shadow','0 0 5px pink')

		}).mouseup(function(event) {

			$(this).css('box-shadow', 'none');
			
			setTimeout(function  () {
				
			bodySelect_g(true)
				
			},3000)

		}).click(function() {

			bodySelect_g(false)

			music_index = (music_index === music_list.length-1) ? 0 : music_index+1;  
			
			$('.song-list-ul').find('li:eq('+(music_index+1)+')').trigger('dblclick');

		});

		$('.volume-0').click(function(event) {
			
			dragInit($('.volume-drag').children('div').children('a'))
			 player.volume = 0 ;

		});

		$('.volume-1').click(function(event) {

			var drag_to_full = (function  ($dom) {
			
			var width = $dom.next().outerWidth()+
			$dom.prev().outerWidth() -$dom.outerWidth();

			$dom.css('left', width + 'px');

			$dom.prev().outerWidth(width);

			$dom.next().outerWidth($dom.outerWidth());
		})($('.volume-drag').children('div').children('a'))

			 player.volume = 1 ;			

		});

		setTimeout( function() {

			//set autoplay when open,if you want to autoplay,just delete one .trigger

			$('#play-button').trigger('click').trigger('click')

		},100)

		$('.volume-1').trigger('click');

		// for(var i = 0;i<music_list.length;i++)
		// console.log(music_list[i].match(reg_music));

		})
var a = 0;
var a = '0';

// console.dir(window)
	</script>
</body>
</html>
